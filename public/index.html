<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Stok & Müşteri Yönetimi Test Paneli</title>
  <style>
    body { font-family: sans-serif; background: #f6f6f6; }
    h2 { margin-top: 2em; }
    .panel { background: #fff; border-radius: 8px; padding: 20px; margin: 30px auto; max-width: 440px; box-shadow: 0 2px 10px #0001; }
    input, select, button { margin: 6px 0; padding: 6px; font-size: 1em; width: 100%; box-sizing: border-box; }
    .resp, .error { font-size: 0.95em; border-radius: 6px; margin-top: 8px; padding: 8px; }
    .resp { background: #e7fbe7; color: #234c23; }
    .error { background: #ffe3e8; color: #8c2330; }
    .token { font-size: 0.93em; color: #666; background: #eef; padding: 4px; border-radius: 4px; margin-bottom: 8px; word-break: break-all;}
    .flex { display: flex; gap: 8px; }
    .flex > * { flex: 1; }
    label { margin-top: 7px; font-weight: 500; }
    .checkbox { width: auto; }
    .small-note { font-size: 0.87em; color: #555; }
    hr { margin: 2em auto; border: none; border-top: 1px solid #ddd; }
  </style>
</head>
<body>
  <div class="panel">
    <h2>1. Kullanıcı Girişi / Kayıt</h2>
    <div>
      <label>Kullanıcı Adı</label>
      <input id="login-username" autocomplete="username">
      <label>Şifre</label>
      <input id="login-password" type="password" autocomplete="current-password">
      <label>Rol (Kayıt için)</label>
      <select id="login-role">
        <option value="">(Kayıt değilse boş bırak)</option>
        <option value="admin">admin</option>
        <option value="patron">patron</option>
        <option value="calisan">calisan</option>
      </select>
      <div class="flex">
        <button id="btn-login">Giriş Yap</button>
        <button id="btn-register">Kayıt Ol</button>
      </div>
      <div id="login-result"></div>
      <div id="token-div" style="display:none;">
        <div class="small-note">JWT Token:</div>
        <div class="token" id="jwt-token"></div>
        <div><b>Kullanıcı:</b> <span id="user-info"></span></div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>2. Müşteri Ekle</h2>
    <div>
      <form id="customer-form">
        <label>Ad *</label>
        <input name="name" required>
        <label>Soyad *</label>
        <input name="surname" required>
        <label><input type="checkbox" id="consent-checkbox" class="checkbox" name="consent_personal_data"> Kişisel verilerimi işleyebilirsiniz</label>
        <div id="personal-fields" style="display:none;">
          <label>Doğum Tarihi</label>
          <input name="birthdate" type="date">
          <label>TCKN (11 haneli)</label>
          <input name="tckn" maxlength="11">
        </div>
        <button>Ekle</button>
      </form>
      <div class="small-note">* Doğum tarihi ve TCKN sadece KVKK kutusu işaretliyse aktif olur.</div>
      <div id="customer-result"></div>
    </div>
  </div>

  <div class="panel">
    <h2>3. Kategori Ekle / Listele</h2>
    <form id="category-form">
      <label>Kategori Adı *</label>
      <input name="name" required>
      <label>IMEI Gerekli mi? *</label>
      <select name="requires_imei">
        <option value="0">Hayır</option>
        <option value="1">Evet</option>
      </select>
      <label>Mağaza ID *</label>
      <input name="store_id" required>
      <button>Ekle</button>
    </form>
    <div id="category-result"></div>
    <button id="btn-list-categories" style="margin-top:12px;">Kategorileri Listele</button>
    <div id="category-list"></div>
  </div>

  <div class="panel">
    <h2>4. Ürün Ekle</h2>
    <form id="product-form">
      <label>Ürün Adı *</label>
      <input name="name" required>
      <label>Barkod *</label>
      <input name="barcode" required>
      <label>Kategori *</label>
      <select name="category_id" id="product-category"></select>
      <label>Stok *</label>
      <input name="stock" type="number" value="1" min="0" required>
      <label>Minimum Stok *</label>
      <input name="min_quantity" type="number" value="1" min="0" required>
      <label>Fiyat *</label>
      <input name="price" type="number" step="0.01" value="0" min="0" required>
      <div id="imei-fields" style="display:none;">
        <label>IMEI 1</label>
        <input name="imei1" id="imei1" maxlength="15">
        <label id="imei2-label" style="display:none;">IMEI 2</label>
        <input name="imei2" id="imei2" maxlength="15" style="display:none;">
        <button id="btn-add-imei2" type="button" style="margin:6px 0;">2. IMEI Ekle</button>
      </div>
      <button>Ekle</button>
    </form>
    <div class="small-note">Kategori seçimine göre IMEI alanı açılır. Çift SIM için 2. IMEI eklenebilir.</div>
    <div id="product-result"></div>
  </div>

  <div class="panel">
    <h2>5. Rıza Kayıtlarını Listele (admin/patron)</h2>
    <button id="btn-list-consents">Rıza Kayıtlarını Getir</button>
    <div id="consent-list"></div>
  </div>

  <script>
    // ==================== GENEL ==================
    const API = "http://localhost:3001/api";
    let JWT = "";
    let USER = null;
    function setToken(token, user) {
      JWT = token;
      USER = user;
      document.getElementById("token-div").style.display = "block";
      document.getElementById("jwt-token").innerText = token;
      document.getElementById("user-info").innerText = user ? user.username + " (" + user.role + ")" : "";
    }
    function showResult(id, msg, ok = true) {
      const el = document.getElementById(id);
      el.innerHTML = `<div class="${ok ? 'resp' : 'error'}">${typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)}</div>`;
    }

    // ============== 1. LOGIN / REGISTER =============
    document.getElementById('btn-login').onclick = async function() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      showResult("login-result", "İşleniyor...");
      try {
        const res = await fetch(API + "/auth/login", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (data.token) { setToken(data.token, data.user); showResult("login-result", "Başarılı giriş!"); }
        else showResult("login-result", data.error || data, false);
      } catch (e) { showResult("login-result", e.message, false); }
      return false;
    };
    document.getElementById('btn-register').onclick = async function() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const role = document.getElementById('login-role').value;
      showResult("login-result", "İşleniyor...");
      try {
        const res = await fetch(API + "/auth/register", {
          method: "POST", headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, role: role || undefined })
        });
        const data = await res.json();
        if (res.status === 201) showResult("login-result", "Kayıt başarılı, giriş yapabilirsin.");
        else showResult("login-result", data.error || data, false);
      } catch (e) { showResult("login-result", e.message, false); }
      return false;
    };

    // ============ 2. MÜŞTERİ EKLEME ==============
    document.getElementById('consent-checkbox').onchange = function() {
      document.getElementById('personal-fields').style.display = this.checked ? 'block' : 'none';
    };
    document.getElementById('customer-form').onsubmit = async function(e) {
      e.preventDefault();
      showResult("customer-result", "İşleniyor...");
      const form = e.target;
      const formData = Object.fromEntries(new FormData(form).entries());
      formData.consent_personal_data = !!formData.consent_personal_data;
      if (!JWT) return showResult("customer-result", "Önce giriş yapmalısın!", false);
      try {
        const res = await fetch(API + "/customers", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: "Bearer " + JWT },
          body: JSON.stringify(formData)
        });
        const data = await res.json();
        showResult("customer-result", res.status === 201 ? "Başarılı: " + JSON.stringify(data.customer, null, 2) : (data.error || data), res.status === 201);
      } catch (e) { showResult("customer-result", e.message, false); }
    };

    // ============ 3. KATEGORİ EKLEME/LİSTELEME ===========
    document.getElementById('category-form').onsubmit = async function(e) {
      e.preventDefault();
      showResult("category-result", "İşleniyor...");
      const formData = Object.fromEntries(new FormData(e.target).entries());
      formData.requires_imei = Number(formData.requires_imei);
      if (!JWT) return showResult("category-result", "Önce giriş yapmalısın!", false);
      try {
        const res = await fetch(API + "/categories", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: "Bearer " + JWT },
          body: JSON.stringify(formData)
        });
        const data = await res.json();
        showResult("category-result", res.status === 201 ? "Kategori eklendi!" : (data.error || data), res.status === 201);
      } catch (e) { showResult("category-result", e.message, false); }
    };

    document.getElementById('btn-list-categories').onclick = async function() {
      if (!JWT) return showResult("category-list", "Önce giriş yapmalısın!", false);
      try {
        const res = await fetch(API + "/categories", { headers: { Authorization: "Bearer " + JWT } });
        const cats = await res.json();
        const html = "<b>Kategoriler:</b><ul>" + cats.map(c =>
          `<li>${c.id} - ${c.name} (IMEI: ${c.requires_imei ? 'evet' : 'hayır'}, Mağaza: ${c.store_id})</li>`
        ).join("") + "</ul>";
        showResult("category-list", html);
        fillCategoryDropdown();
      } catch (e) { showResult("category-list", e.message, false); }
    };

    // ============ 4. ÜRÜN EKLEME ===============
    async function fillCategoryDropdown() {
      const sel = document.getElementById("product-category");
      if (!JWT) return;
      const res = await fetch(API + "/categories", { headers: { Authorization: "Bearer " + JWT } });
      const cats = await res.json();
      sel.innerHTML = cats.map(c => `<option value="${c.id}" data-imei="${c.requires_imei}">${c.name}</option>`).join("");
    }
    fillCategoryDropdown();

    document.getElementById("product-category").onchange = function() {
      const sel = this;
      const opt = sel.selectedOptions[0];
      const requires_imei = opt ? Number(opt.getAttribute('data-imei')) : 0;
      document.getElementById("imei-fields").style.display = requires_imei ? 'block' : 'none';
      document.getElementById("imei2").style.display = "none";
      document.getElementById("imei2-label").style.display = "none";
    };

    document.getElementById("btn-add-imei2").onclick = function() {
      document.getElementById("imei2").style.display = "block";
      document.getElementById("imei2-label").style.display = "block";
      this.style.display = "none";
    };

    document.getElementById('product-form').onsubmit = async function(e) {
      e.preventDefault();
      showResult("product-result", "İşleniyor...");
      const form = e.target;
      const formData = Object.fromEntries(new FormData(form).entries());
      formData.stock = Number(formData.stock);
      formData.min_quantity = Number(formData.min_quantity);
      formData.price = Number(formData.price);
      if (!JWT) return showResult("product-result", "Önce giriş yapmalısın!", false);
      try {
        if (!formData.category_id) return showResult("product-result", "Kategori seç!", false);
        const res = await fetch(API + "/products", {
          method: "POST",
          headers: { "Content-Type": "application/json", Authorization: "Bearer " + JWT },
          body: JSON.stringify(formData)
        });
        const data = await res.json();
        showResult("product-result", res.status === 201 ? "Başarılı: " + JSON.stringify(data.product, null, 2) : (data.error || data), res.status === 201);
      } catch (e) { showResult("product-result", e.message, false); }
    };

    // ========== 5. RIZA LİSTELE ==============
    document.getElementById('btn-list-consents').onclick = async function() {
      if (!JWT) return showResult("consent-list", "Önce giriş yapmalısın!", false);
      try {
        const res = await fetch(API + "/consents", { headers: { Authorization: "Bearer " + JWT } });
        if (res.status !== 200) {
          const data = await res.json();
          showResult("consent-list", data.error || data, false);
          return;
        }
        const list = await res.json();
        const html = "<b>Rıza Kayıtları:</b><ul>" + list.map(x =>
          `<li>Müşteri: ${x.Customer ? (x.Customer.name + " " + x.Customer.surname) : '-'} | Tür: ${x.consent_type} | Rıza: ${x.consent_value ? "Evet" : "Hayır"} | Tarih: ${x.consent_date} | Kullanıcı: ${x.User ? x.User.username : '-'}</li>`
        ).join("") + "</ul>";
        showResult("consent-list", html);
      } catch (e) { showResult("consent-list", e.message, false); }
    };

  </script>
</body>
</html>